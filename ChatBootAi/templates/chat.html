{% load static %}
{% if user.is_authenticated %}
{% include 'headerTask.html' %}
{% block content %}

<head>
  <title>Chat Me</title>
  <!-- Include Chart.js library --> 

    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200" />
    <link rel="stylesheet" href="{% static 'chatAi/css/chatStyle.css' %}">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
</head>
<style>

.conversation {
    height: 100%; /* adjust as needed */
    width: 100%;
    overflow-y: auto;
    display: flex;
    flex-direction: column;
}
.conversation-container {
    flex: 1;
    overflow-y: auto;
}
.conversation-compose {
    position: sticky;
    bottom: 0;
    background: white;
}
.responsive-iframe {
    width: 80%;  /* Adjust to your needs */
    height: 500px; /* Adjust to your needs */
}

.responsive-image {
    width: 80%;  /* Adjust to your needs */
    height: auto;
}

/* For tablets */
@media (max-width: 1024px) {
    .responsive-iframe {
        width: 90%;
        height: 400px;
    }
    
    .responsive-image {
        width: 90%;
        height: auto;
    }
}

/* For mobile phones */
@media (max-width: 768px) {
    .responsive-iframe {
        width: 100%;
        height: 300px;
    }

    .responsive-image {
        width: 100%;
        height: auto;
    }
}
  
  /*   -----------------------------------------        */
  .link-black-bg_frame {
      background-color: black;
      color: white; 
      padding: 1px 4px;
      border-radius: 10px;
      text-decoration: none;
  }
  
  .link-black-bg_image {
      background-color: black;
      color: white;  
      max-width: 50%;
      max-height: 50%;
      padding: 1px 4px;
      border-radius: 10px;
      text-decoration: none;
  }

  .message.received {
      word-wrap: break-word; /* Break long words or links */
      overflow-wrap: break-word; /* Break long words when necessary */  
      /* white-space: pre-line; Ensures new lines are respected */
  }
  code, pre {
    background-color: #000;
    color: #fff;
    padding: 2px;
    border-radius: 10px;
    display: block;
     white-space: pre-wrap;  Allows line breaks */
  }

.black-bg {
  background-color: black;
  color: white;
  padding: 2px;
  border-radius: 10px;
}
 
/* Add to your chatStyle.js or inside <style> tags */
.typing-indicator {
    display: flex;
    align-items: center;
    padding: 8px 12px;
}
.typing-indicator span {
    height: 8px;
    width: 8px;
    margin: 0 2px;
    background-color: #999;
    border-radius: 50%;
    display: inline-block;
    animation: typing 1.4s infinite ease-in-out both;
}
.typing-indicator span:nth-child(1) { animation-delay: 0s; }
.typing-indicator span:nth-child(2) { animation-delay: 0.2s; }
.typing-indicator span:nth-child(3) { animation-delay: 0.4s; }
@keyframes typing {
    0% { transform: scale(1); opacity: 0.5; }
    50% { transform: scale(1.5); opacity: 1; }
    100% { transform: scale(1); opacity: 0.5; }
}

</style>

<body>
  
<div class="container my-5">
    <div class="page"> 
  <div class="marvel-device nexus5">
    <div class="top-bar"></div>
    <div class="sleep"></div>
    <div class="volume"></div>
    <div class="camera"></div>
    <div class="screen"> 
      <div class="screen-container"> 
        {% if error != "" %}
          <div class="alert alert-danger" role="alert">
            {{error}}
          </div>
        {% elif success != "" %}
          <div class="alert alert-success" role="alert">
            {{success}}
          </div>
        {% endif %} 
          
        </div>
        <div class="chat">
          <div class="chat-container">
            <div class="user-bar">
              <div class="back">
                <i class="zmdi zmdi-arrow-left"></i>
              </div>
              <div class="avatar">
                <img src="{{BASE_DIR}}/media/chatLogo.png" class="avatar " alt="Avatar">
              </div>
              <div class="name">
                <span>Chat Ai</span> 
                <span class="status">with v. 0.1</span>
              </div>
              <div class="actions more">
                <span class="material-icons">
                        more_vert
                    </span>
              </div>
              <div class="actions attachment">
                 <span class="material-icons">
                        attachment
                    </span>
              </div>
              <div class="actions">
                 <span class="material-icons">
                        phone
                    </span>
              </div>
            </div>
            <div class="conversation y-scale"><div class="conversation-container">
                    {% if msg_show|length == 0 %}
                        <div class="message received">
                            <div>Hello! How can I assist you today? I'm ready to assist you. How may I help you?</div>
                        </div>
                    {% endif %}

                    {% for msg in msg_show %}
                        <div class="message sent">
                            <div>{{ msg.user_input }}</div>
                            <span class="metadata">
                                <span class="time">{{ msg.created_at }}</span>
                            </span>
                        </div>
                        <div class="message received">
                            <div>{{ msg.bot_response|safe }}</div>
                            <span class="metadata">
                                <span class="time">{{ msg.created_at }}</span>
                            </span>
                        </div>
                    {% endfor %}
                </div>
                                
              
                 <form class="conversation-compose my-2 " action="{% url 'chatbot' %}" method="post" enctype="multimedia/part">
                {% csrf_token %}
                <div class="emoji">
                  <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" id="smiley" x="3147" y="3209"><path fill-rule="evenodd" clip-rule="evenodd" d="M9.153 11.603c.795 0 1.44-.88 1.44-1.962s-.645-1.96-1.44-1.96c-.795 0-1.44.88-1.44 1.96s.645 1.965 1.44 1.965zM5.95 12.965c-.027-.307-.132 5.218 6.062 5.55 6.066-.25 6.066-5.55 6.066-5.55-6.078 1.416-12.13 0-12.13 0zm11.362 1.108s-.67 1.96-5.05 1.96c-3.506 0-5.39-1.165-5.608-1.96 0 0 5.912 1.055 10.658 0zM11.804 1.01C5.61 1.01.978 6.034.978 12.23s4.826 10.76 11.02 10.76S23.02 18.424 23.02 12.23c0-6.197-5.02-11.22-11.216-11.22zM12 21.355c-5.273 0-9.38-3.886-9.38-9.16 0-5.272 3.94-9.547 9.214-9.547a9.548 9.548 0 0 1 9.548 9.548c0 5.272-4.11 9.16-9.382 9.16zm3.108-9.75c.795 0 1.44-.88 1.44-1.963s-.645-1.96-1.44-1.96c-.795 0-1.44.878-1.44 1.96s.645 1.963 1.44 1.963z" fill="#7d8489"/></svg>
                </div>
                <input class="input-msg" name="user_input" placeholder="Type your Query here?" autocomplete="off" autofocus required></input>
                <div class="photo">
                  <i class="zmdi zmdi-camera"></i>
                </div>
                <button class="send" type="submit"> 
                    <div class="circle">
                      <span class="material-icons">
                        send
                    </span>
                    </div>
                  </button>
              </form>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
</div>
  {% endblock %}
  {% include 'footerTask.html' %}
{% endif %}

<script>
    // WebSocket connection manager
    let chatSocket;
    let isConnecting = false;
    let reconnectAttempts = 0;

    const form = document.querySelector('.conversation-compose');
    const input = document.querySelector('.input-msg');
    const conversationContainer = document.querySelector('.conversation-container');
    
    // Create loader element (hidden initially)
    const loader = document.createElement('div');
    loader.className = 'message received';
    loader.innerHTML = '<div class="typing-indicator"><span></span><span></span><span></span></div>';
    let loaderVisible = false;

    // Helper to send messages through WebSocket
    function sendSocket(data) {
        if (chatSocket && chatSocket.readyState === WebSocket.OPEN) {
            chatSocket.send(JSON.stringify(data));
        } else {
            console.warn('WebSocket not open. Message not sent:', data);
        }
    }

    // Handle incoming messages from server
    function handleSocketMessage(data) {
        if (data.error) {
            hideLoader();
            const errorDiv = document.createElement('div');
            errorDiv.className = 'message received error';
            errorDiv.innerHTML = '<div>Error: ' + data.error + '</div>';
            conversationContainer.appendChild(errorDiv);
        } else if (data.type === 'bot_response' && data.message) {
            hideLoader();
            const botMsgDiv = document.createElement('div');
            botMsgDiv.className = 'message received';
            botMsgDiv.innerHTML = `
                <div>${data.message}</div>
                <span class="metadata"><span class="time">${ data.created_at }</span></span>
            `;
            conversationContainer.appendChild(botMsgDiv);
        } else if (data.type === 'typing') {
            if (data.status) {
                showLoader();
            } else {
                hideLoader();
            }
        } else if (data.type === 'initial_state') {
            console.log('Initial state received');
        }
        scrollToBottom();
    }

    // Establish WebSocket connection
    function connectWebSocket() {
        if (isConnecting) return;
        
        isConnecting = true; 
        chatSocket = new WebSocket(
            (window.location.protocol === 'https:' ? 'wss://' : 'ws://') + 
            window.location.host + '/ws/chat/live_chatboot/'
        );

        chatSocket.onopen = () => {
            isConnecting = false;
            reconnectAttempts = 0;
            console.log('âœ… WebSocket connected'); 
        };

        chatSocket.onclose = (e) => {
            isConnecting = false;
            console.error('WebSocket disconnected. Retrying...');
            reconnectAttempts++;
            const delay = Math.min(3000 * reconnectAttempts, 3000);
            setTimeout(connectWebSocket, delay);
        };

        chatSocket.onerror = (e) => {
            console.error("WebSocket error:", e);
            chatSocket.close();
        };

        chatSocket.onmessage = (e) => {
            try {
                const data = JSON.parse(e.data);
                handleSocketMessage(data);
            } catch (error) {
                console.error("Message parsing error:", error);
            }
        };
    }

    // Intercept form submission
    form.addEventListener('submit', function(event) {
        event.preventDefault();
        const message = input.value.trim();
        if (message === '') return;

        // Display user message immediately
        const userMsgDiv = document.createElement('div');
        userMsgDiv.className = 'message sent';
        userMsgDiv.innerHTML = '<div>' + escapeHtml(message) + '</div>' +
            '<span class="metadata"><span class="time">Just now</span></span>';
        conversationContainer.appendChild(userMsgDiv);
 
        sendSocket({ action: 'send_message', message: message });
 
        input.value = '';
        showLoader();
        scrollToBottom();
    });

    function showLoader() {
        if (!loaderVisible) {
            conversationContainer.appendChild(loader);
            loaderVisible = true;
            scrollToBottom();
        }
    }

    function hideLoader() {
        if (loaderVisible) {
            loader.remove();
            loaderVisible = false;
        }
    }

    function scrollToBottom() {
        const chat = document.querySelector('.conversation');
        chat.scrollTop = chat.scrollHeight;
    }

    // Basic escaping to prevent XSS (though your backend also validates)
    function escapeHtml(unsafe) {
        return unsafe
            .replace(/&/g, "&amp;")
            .replace(/</g, "&lt;")
            .replace(/>/g, "&gt;")
            .replace(/"/g, "&quot;")
            .replace(/'/g, "&#039;");
    }

    // Start connection when page loads
    document.addEventListener('DOMContentLoaded', () => {
        connectWebSocket();
    });
</script>
 

<script>
  document.getElementById('chat-form').addEventListener('submit', function() {
      document.getElementById('user_input').value = ''; // Clear the input field after submission
  });
</script>
<script src="{% static 'chatAi/js/chatStyle.js' %}"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<!-- JavaScript to render the chart -->
 
